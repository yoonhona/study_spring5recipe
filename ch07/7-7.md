레피시 7-7 도메인 객체 보안 처리하기

기타
---
[Spring Framework Reference Integration Cache](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache)
  - 스프링 4.1 JSR-107 annotations과 커스텀 옵션을 지원하여 추상화 향상
  - 설정가능한 cache storage
    1. [JDK ConcurrentMap-based Cache](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache-store-configuration-jdk)
    2. [Ehcache-based Cache](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache-store-configuration-ehcache)
    3. [Caffeine Cache](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache-store-configuration-caffeine)
    4. [GemFire-based Cache](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache-store-configuration-gemfire)
    5. [JSR-107 Cache](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache-store-configuration-jsr107)
    6. [Dealing with caches without a backing store](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#cache-store-configuration-noop)

과제
---
도메 인 객체 레벨에서 보안을 처리

해결책
---
- 스프링 시큐리티는 자체 ACL(Acces Control List)을 설정하는 전용 모듈 지원
- ACL에는 도메인 객체와 연결하는 ID를 비롯 여러개의 ACE(Access Control Entry)를 포함
  - ACE 두 가지 핵심 요소
    - Permission(인가받은 권한)
      - 특정 퍼미션을 의미하는 비트 마스크
      - BasePermission 클래스 다섯 가지 기본 퍼미션
      ```java
      public class BasePermission extends AbstractPermission {
        public static final Permission READ = new BasePermission(1 << 0, 'R'); // 1
        public static final Permission WRITE = new BasePermission(1 << 1, 'W'); // 2
        public static final Permission CREATE = new BasePermission(1 << 2, 'C'); // 4
        public static final Permission DELETE = new BasePermission(1 << 3, 'D'); // 8
        public static final Permission ADMINISTRATION = new BasePermission(1 << 4, 'A'); // 16
        ...
      ```
    - SID(Security IDentity, 보안 식별자)
      - ACE는 특정 SID에 대한 퍼미션을 가짐
      - SID는 주체(PrincipalSid)일 수도 있고 퍼미션과 연관된 권한(GrantedAuthoritySid)일 수도 있음
      - 스프링 시큐리티에는 ACL 객체 모델의 정의뿐만 아니라 이 모델을 읽고 관리하는 API도 정의 또한 이 API를 구현한 고성능 JDBC 구현체까지 제공
      - 접근통제 거수기나 JSP 태그 등의 편의 기능도 있어 애플리케이션의 다른 보안 장치들과 일관된 방향으로 사용 가능

## 풀이
- ACL 서비스를 설정하는 방법과 엔티티의 ACL의 퍼미션을 다루는 방법과 보안 표현식의 사용법을 알아보자



#### ACL 서비스 설정하기

<details>
  <summary>DB 테이블 생성</summary>

```sql
CREATE TABLE ACL_SID(
    ID         BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    SID        VARCHAR(100)  NOT NULL,
    PRINCIPAL  SMALLINT      NOT NULL,
    PRIMARY KEY (ID),
    UNIQUE (SID, PRINCIPAL)
);

CREATE TABLE ACL_CLASS(
    ID     BIGINT        NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    CLASS  VARCHAR(100)  NOT NULL,
    PRIMARY KEY (ID),
    UNIQUE (CLASS)
);

CREATE TABLE ACL_OBJECT_IDENTITY(
    ID                  BIGINT    NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    OBJECT_ID_CLASS     BIGINT    NOT NULL,
    OBJECT_ID_IDENTITY  BIGINT    NOT NULL,
    PARENT_OBJECT       BIGINT,
    OWNER_SID           BIGINT,
    ENTRIES_INHERITING  SMALLINT  NOT NULL,
    PRIMARY KEY (ID),
    UNIQUE (OBJECT_ID_CLASS, OBJECT_ID_IDENTITY),
    FOREIGN KEY (PARENT_OBJECT)   REFERENCES ACL_OBJECT_IDENTITY,
    FOREIGN KEY (OBJECT_ID_CLASS) REFERENCES ACL_CLASS,
    FOREIGN KEY (OWNER_SID)       REFERENCES ACL_SID
);

CREATE TABLE ACL_ENTRY(
    ID                  BIGINT    NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    ACL_OBJECT_IDENTITY BIGINT    NOT NULL,
    ACE_ORDER           INT       NOT NULL,
    SID                 BIGINT    NOT NULL,
    MASK                INTEGER   NOT NULL,
    GRANTING            SMALLINT  NOT NULL,
    AUDIT_SUCCESS       SMALLINT  NOT NULL,
    AUDIT_FAILURE       SMALLINT  NOT NULL,
    PRIMARY KEY (ID),
    UNIQUE (ACL_OBJECT_IDENTITY, ACE_ORDER),
    FOREIGN KEY (ACL_OBJECT_IDENTITY) REFERENCES ACL_OBJECT_IDENTITY,
    FOREIGN KEY (SID)                 REFERENCES ACL_SID
);
```
>org.springframework.security.acls.createAclSchema.sql  
>org.springframework.security.acls.createAclSchemaMySQL.sql  
>org.springframework.security.acls.createAclSchemaOracle.sql  
>org.springframework.security.acls.createAclSchemaPostgres.sql  
>org.springframework.security.acls.createAclSchemaSqlServer.sql  
>org.springframework.security.acls.createAclSchemaWithAclClassIdType.sql

</details>

<details>
<summary>캐싱</summary>

- 도메인 객체가 많아질수록 전체 ACL 개수도 증가, 스프링 시큐리티는 ACL 객체를 캐시하는 기능을 지원
```xml
<ehcache>
...
    <cache 
        name="aclCache"
        maxElementsInMemory="1000"
        eternal="false"
        timeToIdleSeconds="600"
        timeToLiveSeconds="3600"
        overflowToDisk="true"
    />
</ehcache>
```

</details>
<details>
<summary>ACL 서비스 설정</summary>

- ACL 빈 구성 클랙스를 따로 작성 배포 기술자에 추가
```java
public class TodoSecurityInitializer extends AbstractSecurityWebApplicationInitializer {
    public TodoSecurityInitializer() {
        super(TodoSecurityConfig.class, TodoAclConfig.class);
    }
}
```
- ACL 빈 구성 클래스
```java
@Configuration
public class TodoAclConfig {

    private final DataSource dataSource;

    public TodoAclConfig(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    @Bean
    public AclService aclService(LookupStrategy lookupStrategy, AclCache aclCache) {
        return new JdbcMutableAclService(this.dataSource, lookupStrategy, aclCache);
    }
    // ACL 서비스 작업은 AclService, MutableAclService 인터페이스로 정의
    // AclService 인터페이스는 읽기 작업, 하위 인터페이스인 MutableAclService는 생성, 수정, 삭제를 기술
    // 호환이 안되는 RDBMS를 사용할 경우 쿼리 작성 필요 
    
    @Bean
    public LookupStrategy lookupStrategy(AclCache aclCache) {
        return new BasicLookupStrategy(
                this.dataSource, 
                aclCache, 
                aclAuthorizationStrategy(), 
                permissionGrantingStrategy());
    }
    // BasicLookupStrategy 표준/화환 SQL문으로 기본 룩업을 수행하는 스프링 유일한 LookupStrategy 인터페이스 구현체
    // 고급 기능을 사용하려면 LookupStrategy 인터페이스 구현 필요

    @Bean
    public AclAuthorizationStrategy aclAuthorizationStrategy() {
        return new AclAuthorizationStrategyImpl(new SimpleGrantedAuthority("ADMIN"));
    }
    // 각 프로퍼티 카테고리별로 필요한 권한을 지정하는 식으로 주체가 특정
    // ACL 프로퍼티를 변경할 권한을 갖고 있는 판단
    
    @Bean
    public PermissionGrantingStrategy permissionGrantingStrategy() {
        return new DefaultPermissionGrantingStrategy(auditLogger());
    }
    // 자신이 가지고 있는 Permission 값으로 주어진 SID에 ACL 액세스를 허용할지 결정
    
    @Bean
    public AclEntryVoter aclEntryVoter(AclService aclService) {
        return new AclEntryVoter(aclService, "ACL_MESSAGE_DELETE", new Permission[]{BasePermission.ADMINISTRATION, BasePermission.DELETE});
    }

    @Bean
    public EhCacheCacheManager ehCacheManagerFactoryBean() {
        return new EhCacheCacheManager();
    }

    @Bean
    public AuditLogger auditLogger() {
        return new ConsoleAuditLogger();
    }
    
    @Bean
    public AclCache aclCache(CacheManager cacheManager) {
        return new SpringCacheBasedAclCache(cacheManager.getCache("aclCache"), permissionGrantingStrategy(), aclAuthorizationStrategy());
    }
    
    @Bean
    public AclPermissionEvaluator permissionEvaluator(AclService aclService) {
        return new AclPermissionEvaluator(aclService);
    }
}
```
</details>

<details>
<summary>도메인 객체에 ACL 관리하기</summary>

```java
@Service
@Transactional
class TodoServiceImpl implements TodoService {

    private final TodoRepository todoRepository;
    private final MutableAclService mutableAclService;
    
    TodoServiceImpl(TodoRepository todoRepository, MutableAclService mutableAclService) {
        this.todoRepository = todoRepository;
        this.mutableAclService = mutableAclService;
    }

    @Override
    @PreAuthorize("hasAuthority('USER')")
    public void save(Todo todo) {

        this.todoRepository.save(todo);

        ObjectIdentity oid = new ObjectIdentityImpl(Todo.class, todo.getId());
        MutableAcl acl = mutableAclService.createAcl(oid);
        acl.insertAce(0, READ, new PrincipalSid(todo.getOwner()), true);
        acl.insertAce(1, WRITE, new PrincipalSid(todo.getOwner()), true);
        acl.insertAce(2, DELETE, new PrincipalSid(todo.getOwner()), true);

        acl.insertAce(3, READ, new GrantedAuthoritySid("ADMIN"), true);
        acl.insertAce(4, WRITE, new GrantedAuthoritySid("ADMIN"), true);
        acl.insertAce(5, DELETE, new GrantedAuthoritySid("ADMIN"), true);

    }
    @Override
    @PreAuthorize("hasAuthority('USER', 'ADMIN')")
    public void remove(long id) {
        todoRepository.remove(id);

        ObjectIdentity oid = new ObjectIdentityImpl(Todo.class, id);
        mutableAclService.deleteAcl(oid, false);
    }
}


@EnableTransactionManagement
public class TodoWebConfig implements WebMvcConfigurer {
...
    @Bean
    public DataSourceTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```
</details>

<details>
<summary>표현식을 이용해 접근 통제 결정하기</summary>

- @PreAuthorize/@PreFilter : 유저가 메서드 실행, 또는 특정 메서드 인수의 사용 권한이 있는지 체크
- @PreAuthorize/PostFilter : 유저가 메서드 실행 결과에 접근하거나 ACL에 따라 그 결과를 필터링 할 수 있는지 체크

```java
@EnableGlobalMethodSecurity(prePostEnabled = true) // 위의 애너테이션 사용을 위한 설정
public class TodoWebConfig implements WebMvcConfigurer {
...
    @Bean
    public AclPermissionEvaluator permissionEvaluator(AclService aclService) {
        return new AclPermissionEvaluator(aclService);
    }
...
}


@Service
@Transactional
class TodoServiceImpl implements TodoService {
    
    @Override
    @PreAuthorize("hasAuthority('USER')")
    @PostFilter("hasAnyAuthority('ADMIN') or hasPermission(filterObject, 'read')")
    public List<Todo> listTodos() {...}

    @Override
    @PreAuthorize("hasAuthority('USER')")
    public void save(Todo todo) {...}

    @Override
    @PreAuthorize("hasPermission(#id, 'com.apress.springrecipes.board.Todo', 'write')")
    public void complete(long id) {...}

    @Override
    @PreAuthorize("hasPermission(#id, 'com.apress.springrecipes.board.Todo', 'delete')")
    public void remove(long id) {...}

    @Override
    @PostFilter("hasPermission(filterObject, 'read')")
    public Todo findById(long id) {...}
}
```
</details>
